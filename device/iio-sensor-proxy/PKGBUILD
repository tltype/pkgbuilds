# Maintainer: Raihan Ahamed (raihan2000) <raihan1999ahamed@gmail.com>
# Contributor: Filipe La√≠ns (FFY00) <lains@archlinux.org>
# Contributor: Eric Lehmann <katyl@katyl.info>
# Contributor: Thomas Fanninger <thomas@fanninger.at>
# Contributor: ultraviolet <ultravioletnanokitty@gmail.com>
# Contributor: Pablo Lezeta <prflr88@gmail.com>
_mode=host
_crossdirect=false
pkgname=iio-sensor-proxy
pkgdesc="IIO accelerometer sensor to input device proxy"
pkgver=3.7.r0.gbfcf0c8
pkgrel=1
_arches=all
arch=(
    x86_64
    armv7h
    aarch64
)
license=(GPL2)
url=https://gitlab.freedesktop.org/hadess/iio-sensor-proxy/
depends=(
    systemd
    libgudev
    glib2
    polkit
    "libssc>=0.2.1"
)
makedepends=(
    gtk3
    meson
)
checkdepends=(
    python-gobject
    python-dbusmock
    python-psutil
    umockdev
)
_commit=bfcf0c867bbba90ef26138c99da5780a76d9b99b
_libssc_commit=af17d8f3a7572ed2be40d5a28c6ce08c74bd36c7
source=(
    "git+https://gitlab.freedesktop.org/hadess/iio-sensor-proxy.git#commit=$_commit"
    https://gitlab.com/postmarketOS/pmaports/-/raw/$_libssc_commit/temp/iio-sensor-proxy/0001-iio-sensor-proxy-depend-on-libssc.patch
    https://gitlab.com/postmarketOS/pmaports/-/raw/$_libssc_commit/temp/iio-sensor-proxy/0002-proximity-support-SSC-proximity-sensor.patch
    https://gitlab.com/postmarketOS/pmaports/-/raw/$_libssc_commit/temp/iio-sensor-proxy/0003-light-support-SSC-light-sensor.patch
    https://gitlab.com/postmarketOS/pmaports/-/raw/$_libssc_commit/temp/iio-sensor-proxy/0004-accelerometer-support-SSC-accelerometer-sensor.patch
    https://gitlab.com/postmarketOS/pmaports/-/raw/$_libssc_commit/temp/iio-sensor-proxy/0005-compass-support-SSC-compass-sensor.patch
    https://gitlab.com/postmarketOS/pmaports/-/raw/$_libssc_commit/temp/iio-sensor-proxy/0006-data-add-libssc-udev-rules.patch
    https://gitlab.com/postmarketOS/pmaports/-/raw/$_libssc_commit/temp/iio-sensor-proxy/0007-data-iio-sensor-proxy.service.in-add-AF_QIPCRTR.patch
    https://gitlab.com/postmarketOS/pmaports/-/raw/$_libssc_commit/temp/iio-sensor-proxy/0008-drv-ssc-implement-set_polling.patch
    https://gitlab.com/postmarketOS/pmaports/-/raw/$_libssc_commit/temp/iio-sensor-proxy/0009-tests-integration-test-add-SSC-sensors.patch
    system-iio-sensor-proxy.service.d-hexagonrpcd.conf
)
sha256sums=(
    63c9e3bfe0e166f773c79e09f18954bf047d90b7b724fcb7beb2a26dc8bcd29b
    94e00783cd3eb66bc69f36056817952335746b9b14e8482b1ea293e211ee0976
    3d47e8089afaa34785216c6459c5260b5800e9c7f92a4eaf3e249bb6e3ad6ec9
    b77aa1f175595361bfc1f32bfd72e0946824feaa4e443a95e5db1f6cf61e9f4b
    e36caeb437ddfe9493eb08d9a4785970b5aabc1e1e3d23cff475d739a19efeaf
    59e4e6e21a82a52d90af4136454908792094e07ed22f1507c3157706eacead60
    de802c803f86c137178d575ba52e90cf7332c91ddff2d53c223c2dca8d55b52b
    844513017177ae558c3b409f6bd1f639f7d1c88d8cbbe2b9fc09f81f4f23003f
    39d010db54f51de6778bf3f4fa001c2ae2a08736e8f1c5e565b2d7aa0f45d010
    cb283672832d03a535a44f203e01ec147605daefab1cc229ad70bc55952ef8ee
    5e56ebe9e07a5167c9489c54887432e095cd08408fe11cb3de06a40e034240c5
)

pkgver() {
    cd $pkgname
    git describe --long --tags --abbrev=7 "$_commit" | sed 's/^v//;s/\([^-]*-g\)/r\1/;s/-/./g'
}

prepare() {
    cd $pkgname
    for patchfile in "${srcdir}"/*.patch; do
        patch --forward --strip=1 --input="$patchfile"
    done
}

build() {
    mkdir $pkgname/build
    cd $pkgname/build

    arch-meson .. \
        -Dssc-support=true \
        -Dsystemdsystemunitdir=/usr/lib/systemd/system \
        -Dudevrulesdir=/usr/lib/udev/rules.d \
        -Dsysconfdir=/usr/share

    ninja
}

#check() {
#    cd $pkgname/build
#   needs French locale
#   ninja test
#}

package() {
    cd $pkgname/build

    DESTDIR="$pkgdir" ninja install

    install -Dm644 "$srcdir"/system-iio-sensor-proxy.service.d-hexagonrpcd.conf "$pkgdir"/usr/lib/systemd/system/iio-sensor-proxy.service.d/hexagonrpcd.conf
}
